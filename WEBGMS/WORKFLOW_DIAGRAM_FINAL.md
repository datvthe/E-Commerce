# ğŸ“Š WORKFLOW Äáº¶T HÃ€NG DIGITAL GOODS - DIAGRAM HOÃ€N CHá»ˆNH

## ğŸ¯ NGUYÃŠN Táº®C Cá»T LÃ•I

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âš ï¸ 1 ORDER = 1 CODE DUY NHáº¤T (QUANTITY LUÃ”N = 1)            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  User muá»‘n 3 codes â†’ Há»‡ thá»‘ng táº¡o 3 orders riÃªng biá»‡t        â•‘
â•‘  Má»—i order chá»‰ chá»©a 1 code, quantity cá»‘ Ä‘á»‹nh = 1             â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“¦ Ká»ŠCH Báº¢N MUA HÃ€NG

### User muá»‘n mua 3 codes "Tháº» cÃ o Viettel 100K"

```
Input:
- Product ID: 1 (Tháº» cÃ o Viettel 100K)
- Quantity: 3
- Price: 95,000Ä‘/code
- Total: 285,000Ä‘

Output:
- 3 orders riÃªng biá»‡t (101, 102, 103)
- Má»—i order chá»©a 1 code duy nháº¥t
- Trá»« tiá»n 1 láº§n: 285,000Ä‘
```

---

## ğŸ”„ WORKFLOW CHI TIáº¾T

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BÆ¯á»šC 1: USER CHá»ŒN Sáº¢N PHáº¨M                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User á»Ÿ product-detail.jsp:
- Chá»n "Tháº» cÃ o Viettel 100K"
- Nháº­p quantity = 3
- Nháº¥n "Mua ngay"
        â”‚
        â–¼
GET /checkout/instant?productId=1&quantity=3

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ InstantCheckoutController                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š CHECK STOCK:                                                 â”‚
â”‚                                                                 â”‚
â”‚   SELECT COUNT(*) FROM digital_goods_codes                      â”‚
â”‚   WHERE product_id = 1 AND is_used = 0                         â”‚
â”‚   â†’ availableStock = 5 codes                                    â”‚
â”‚                                                                 â”‚
â”‚ âœ… 3 <= 5 â†’ OK, Ä‘á»§ hÃ ng                                         â”‚
â”‚                                                                 â”‚
â”‚ ğŸ’° CHECK WALLET:                                                â”‚
â”‚   SELECT balance FROM wallets WHERE user_id = 11                â”‚
â”‚   â†’ balance = 500,000Ä‘                                          â”‚
â”‚   â†’ required = 285,000Ä‘ (95,000 Ã— 3)                           â”‚
â”‚                                                                 â”‚
â”‚ âœ… 500,000 >= 285,000 â†’ OK, Ä‘á»§ tiá»n                            â”‚
â”‚                                                                 â”‚
â”‚ â†’ Forward to checkout-instant.jsp (trang xÃ¡c nháº­n)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ User nháº¥n "XÃ¡c nháº­n thanh toÃ¡n"
        â–¼
POST /checkout/process 
{productId: 1, quantity: 3}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CheckoutProcessController                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”’ START TRANSACTION                                             â”‚
â”‚    conn.setAutoCommit(false)                                    â”‚
â”‚                                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚ STEP 1: LOCK 3 codes                                           â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚   SELECT * FROM digital_goods_codes                             â”‚
â”‚   WHERE product_id = 1 AND is_used = 0                         â”‚
â”‚   LIMIT 3                                                       â”‚
â”‚   FOR UPDATE;                                                   â”‚
â”‚                                                                 â”‚
â”‚   â†’ codes: [code_id=1, code_id=2, code_id=3]                   â”‚
â”‚                                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚ STEP 2: Trá»« tiá»n wallet (1 Láº¦N cho tá»•ng tiá»n)                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚   UPDATE wallets                                                â”‚
â”‚   SET balance = balance - 285000                                â”‚
â”‚   WHERE user_id = 11;                                           â”‚
â”‚                                                                 â”‚
â”‚   INSERT INTO transactions (                                    â”‚
â”‚     type = 'WITHDRAW',                                          â”‚
â”‚     amount = 285000,                                            â”‚
â”‚     note = 'Mua 3 codes Tháº» cÃ o Viettel'                       â”‚
â”‚   )                                                            â”‚
â”‚                                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚ STEP 3: Táº O 3 ORDERS (1 order per code)                       â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚ FOR i = 0 to 2:                                                â”‚
â”‚   code = availableCodes[i]                                      â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ Order 1 (cho code_id=1)               â”‚                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚   â”‚ INSERT INTO orders (                  â”‚                   â”‚
â”‚   â”‚   buyer_id = 11,                      â”‚                   â”‚
â”‚   â”‚   seller_id = 2,                      â”‚                   â”‚
â”‚   â”‚   status = 'paid',                    â”‚                   â”‚
â”‚   â”‚   total_amount = 95000   â—„â”€â”€ 1 code   â”‚                   â”‚
â”‚   â”‚ )                                     â”‚                   â”‚
â”‚   â”‚ â†’ order_id = 101                      â”‚                   â”‚
â”‚   â”‚                                       â”‚                   â”‚
â”‚   â”‚ INSERT INTO order_items (             â”‚                   â”‚
â”‚   â”‚   order_id = 101,                     â”‚                   â”‚
â”‚   â”‚   product_id = 1,                     â”‚                   â”‚
â”‚   â”‚   quantity = 1,          â—„â”€â”€ LUÃ”N = 1 â”‚                   â”‚
â”‚   â”‚   price_at_purchase = 95000,          â”‚                   â”‚
â”‚   â”‚   subtotal = 95000                    â”‚                   â”‚
â”‚   â”‚ )                                     â”‚                   â”‚
â”‚   â”‚                                       â”‚                   â”‚
â”‚   â”‚ UPDATE digital_goods_codes            â”‚                   â”‚
â”‚   â”‚ SET is_used = 1, used_by = 11         â”‚                   â”‚
â”‚   â”‚ WHERE code_id = 1;                    â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ Order 2 (cho code_id=2)               â”‚                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚   â”‚ â†’ order_id = 102                      â”‚                   â”‚
â”‚   â”‚ [TÆ°Æ¡ng tá»±]                            â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ Order 3 (cho code_id=3)               â”‚                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚   â”‚ â†’ order_id = 103                      â”‚                   â”‚
â”‚   â”‚ [TÆ°Æ¡ng tá»±]                            â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚ STEP 4: COMMIT                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚   conn.commit();                                                â”‚
â”‚   âœ… 3 orders created: [101, 102, 103]                         â”‚
â”‚                                                                 â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚ STEP 5: Sync inventory (sau khi commit)                       â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚   UPDATE inventory                                              â”‚
â”‚   SET quantity = (SELECT COUNT(*) FROM digital_goods_codes     â”‚
â”‚                   WHERE product_id = 1 AND is_used = 0)        â”‚
â”‚   WHERE product_id = 1;                                         â”‚
â”‚                                                                 â”‚
â”‚   â†’ inventory.quantity: 5 â†’ 2                                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
Response: {
  "status": "SUCCESS",
  "message": "Äáº·t hÃ ng thÃ nh cÃ´ng! ÄÃ£ táº¡o 3 Ä‘Æ¡n hÃ ng",
  "orderId": 101,
  "totalOrders": 3
}
        â”‚
        â–¼
GET /order/success?orderId=101

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrderSuccessController                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Láº¥y táº¥t cáº£ codes cá»§a user cho product nÃ y:                      â”‚
â”‚                                                                 â”‚
â”‚   SELECT * FROM digital_goods_codes                             â”‚
â”‚   WHERE used_by = 11 AND product_id = 1                        â”‚
â”‚   ORDER BY used_at DESC                                         â”‚
â”‚                                                                 â”‚
â”‚   â†’ Káº¿t quáº£: 3 codes                                           â”‚
â”‚     [code_id=1, VT100K001...]                                  â”‚
â”‚     [code_id=2, VT100K002...]                                  â”‚
â”‚     [code_id=3, VT100K003...]                                  â”‚
â”‚                                                                 â”‚
â”‚ â†’ Forward to order-success.jsp                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š TRáº NG THÃI DATABASE SAU KHI MUA

### `orders` table:
```
order_id | buyer_id | seller_id | status | total_amount | created_at
---------|----------|-----------|--------|--------------|--------------------
101      | 11       | 2         | paid   | 95,000       | 2025-11-01 10:30:01
102      | 11       | 2         | paid   | 95,000       | 2025-11-01 10:30:01
103      | 11       | 2         | paid   | 95,000       | 2025-11-01 10:30:01
```

### `order_items` table:
```
item_id | order_id | product_id | quantity | price_at_purchase | subtotal
--------|----------|------------|----------|-------------------|----------
1       | 101      | 1          | 1        | 95,000            | 95,000
2       | 102      | 1          | 1        | 95,000            | 95,000
3       | 103      | 1          | 1        | 95,000            | 95,000
```

### `digital_goods_codes` table:
```
code_id | product_id | code_value      | is_used | used_by | used_at
--------|------------|-----------------|---------|---------|--------------------
1       | 1          | VT100K001...    | 1       | 11      | 2025-11-01 10:30:01
2       | 1          | VT100K002...    | 1       | 11      | 2025-11-01 10:30:01
3       | 1          | VT100K003...    | 1       | 11      | 2025-11-01 10:30:01
4       | 1          | VT100K004...    | 0       | NULL    | NULL
5       | 1          | VT100K005...    | 0       | NULL    | NULL
```

### `wallets` table:
```
wallet_id | user_id | balance (TRÆ¯á»šC) | balance (SAU)
----------|---------|-----------------|---------------
1         | 11      | 500,000         | 215,000       â† Trá»« 285,000
```

### `inventory` table (sau sync):
```
inventory_id | product_id | quantity (TRÆ¯á»šC) | quantity (SAU)
-------------|------------|------------------|----------------
1            | 1          | 5                | 2              â† Sync tá»« COUNT
```

---

## ğŸ¨ HIá»‚N THá»Š TRÃŠN UI

### Trang Order Success (`order-success.jsp`):
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        âœ… Äáº¶T HÃ€NG THÃ€NH CÃ”NG!                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                           â•‘
â•‘  ÄÃ£ táº¡o 3 Ä‘Æ¡n hÃ ng cho sáº£n pháº©m: Tháº» cÃ o Viettel 100K    â•‘
â•‘  ğŸ’° Tá»•ng thanh toÃ¡n: 285,000Ä‘                             â•‘
â•‘  ğŸ’µ Sá»‘ dÆ° cÃ²n láº¡i: 215,000Ä‘                               â•‘
â•‘                                                           â•‘
â•‘ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â•‘
â•‘ â”ƒ ğŸ DANH SÃCH MÃƒ ÄÃƒ MUA (3 MÃƒ)                       â”ƒ  â•‘
â•‘ â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â•‘
â•‘                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â•‘
â•‘  â”‚ Order #101                                     â”‚      â•‘
â•‘  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚      â•‘
â•‘  â”‚ ğŸ“± MÃ£: VT100K001234567890                      â”‚      â•‘
â•‘  â”‚ ğŸ·ï¸  Loáº¡i: Gift Card                            â”‚      â•‘
â•‘  â”‚ ğŸ’µ GiÃ¡: 95,000Ä‘                                â”‚      â•‘
â•‘  â”‚ ğŸ“… NgÃ y: 2025-11-01 10:30:01                   â”‚      â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â•‘
â•‘                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â•‘
â•‘  â”‚ Order #102                                     â”‚      â•‘
â•‘  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚      â•‘
â•‘  â”‚ ğŸ“± MÃ£: VT100K001234567891                      â”‚      â•‘
â•‘  â”‚ ğŸ·ï¸  Loáº¡i: Gift Card                            â”‚      â•‘
â•‘  â”‚ ğŸ’µ GiÃ¡: 95,000Ä‘                                â”‚      â•‘
â•‘  â”‚ ğŸ“… NgÃ y: 2025-11-01 10:30:01                   â”‚      â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â•‘
â•‘                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â•‘
â•‘  â”‚ Order #103                                     â”‚      â•‘
â•‘  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚      â•‘
â•‘  â”‚ ğŸ“± MÃ£: VT100K001234567892                      â”‚      â•‘
â•‘  â”‚ ğŸ·ï¸  Loáº¡i: Gift Card                            â”‚      â•‘
â•‘  â”‚ ğŸ’µ GiÃ¡: 95,000Ä‘                                â”‚      â•‘
â•‘  â”‚ ğŸ“… NgÃ y: 2025-11-01 10:30:01                   â”‚      â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â•‘
â•‘                                                           â•‘
â•‘  [Táº£i láº¡i mÃ£]  [Xem lá»‹ch sá»­ Ä‘Æ¡n hÃ ng]                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“‹ MAPPING GIá»®A CÃC Báº¢NG

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ wallets â”‚      â”‚ transactions â”‚      â”‚   orders   â”‚      â”‚    order_items     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                    â”‚                    â”‚                       â”‚
    â”‚                    â”‚                    â”‚                       â”‚
    â”‚ 1 transaction      â”‚                    â”‚ 3 orders              â”‚
    â”‚ -285,000Ä‘          â”‚                    â”‚ (101, 102, 103)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â”‚ 3 order_items
                                                       â”‚ (quantity=1 each)
                                                       â”‚
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚  digital_goods_    â”‚
                                              â”‚     codes          â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              3 codes marked:
                                              - code_id=1 (used_by=11)
                                              - code_id=2 (used_by=11)
                                              - code_id=3 (used_by=11)
```

---

## ğŸ” CÃC Báº¢NG ÄÆ¯á»¢C Sá»¬ Dá»¤NG

| Báº£ng | Vai trÃ² | SQL Operations |
|------|---------|----------------|
| `digital_goods_codes` | Nguá»“n gá»‘c codes | SELECT (lock), UPDATE (is_used) |
| `wallets` | VÃ­ Ä‘iá»‡n tá»­ | SELECT (check), UPDATE (trá»« tiá»n) |
| `transactions` | Lá»‹ch sá»­ giao dá»‹ch | INSERT (1 record) |
| **`orders`** | **ThÃ´ng tin order** | **INSERT (3 records)** |
| **`order_items`** | **Link order â†” product** | **INSERT (3 records)** |
| `inventory` | Cache sá»‘ lÆ°á»£ng | UPDATE (sau commit) |
| `pending_transactions` | Giá»¯ tiá»n 7 ngÃ y | INSERT (1 record) |

---

## ğŸ“‚ FILES Xá»¬ LÃ NGHIá»†P Vá»¤

### Controllers:
1. `InstantCheckoutController.java` - Check stock & wallet
2. **`CheckoutProcessController.java`** - **Táº¡o NHIá»€U orders (1 per code)**
3. `OrderSuccessController.java` - Hiá»ƒn thá»‹ codes Ä‘Ã£ mua

### DAOs:
1. **`OrderDAO.java`** - **createInstantOrder(1 code), insertOrderItem()**
2. `DigitalGoodsCodeDAO.java` - Lock & mark codes
3. `WalletDAO.java` - Trá»« tiá»n
4. `InventoryDAO.java` - Sync sá»‘ lÆ°á»£ng

### Models:
1. `Orders.java` - Order model
2. `OrderItems.java` - Order item model
3. `DigitalGoodsCode.java` - Digital code model

---

## âš¡ CONSOLE LOG MONG Äá»¢I

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ›’ CHECKOUT: 1 ORDER = 1 CODE DUY NHáº¤T
   User muá»‘n: 3 codes
   â†’ Táº¡o: 3 orders riÃªng biá»‡t
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”’ Locked 3 codes for product 1
  âœ“ Order 1/3: ID=101, Code=1
  âœ“ Added order_item: order=101, product=1, code=1
  âœ“ Marked code 1 as used by user 11
  âœ“ Order 2/3: ID=102, Code=2
  âœ“ Added order_item: order=102, product=1, code=2
  âœ“ Marked code 2 as used by user 11
  âœ“ Order 3/3: ID=103, Code=3
  âœ“ Added order_item: order=103, product=1, code=3
  âœ“ Marked code 3 as used by user 11
âœ… Committed 3 orders successfully!
âœ… Synced inventory for product 1: 2 codes
```

---

## ğŸ¯ Táº I SAO Láº I THIáº¾T Káº¾ NHÆ¯ Váº¬Y?

### âœ… Æ¯u Ä‘iá»ƒm:

1. **ÄÆ¡n giáº£n nháº¥t:** Má»—i order = 1 code, dá»… hiá»ƒu, dá»… code
2. **Refund dá»…:** Cancel 1 order = refund 1 code
3. **Tracking tá»‘t:** Biáº¿t chÃ­nh xÃ¡c code nÃ o thuá»™c order nÃ o
4. **KhÃ´ng phá»©c táº¡p:** Quantity luÃ´n = 1, khÃ´ng cáº§n tÃ­nh toÃ¡n

### âš ï¸ LÆ°u Ã½:

- Náº¿u user mua nhiá»u codes â†’ Nhiá»u orders
- Cáº§n group hiá»ƒn thá»‹ cho Ä‘áº¹p UI

---

**Thiáº¿t káº¿ nÃ y CHUáº¨N 100% theo yÃªu cáº§u cá»§a báº¡n! ğŸ¯**

